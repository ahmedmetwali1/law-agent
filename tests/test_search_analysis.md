"""
๐ ุชุญููู ุขููุฉ ุงูุจุญุซ ูู ุงููุธุงู ุงููุงูููู
================================================

## ุงูุณุคุงู ุงููุทุฑูุญ:
"ูุง ูู ุงูููุงุฏ ุงูุชู ุชุชููู ุนู ุงููุจู ูู ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ"

## ๐ ุชุญููู ุงูุจุญุซ ุงููุนูู (ูู Logs):

### ุงููุฑุญูุฉ 1: Scout Phase (ุงูุงุณุชูุดุงู)
```
23:06:52 - Query Entities: {'articles': [], 'laws': [], 'case_numbers': []}
23:06:52 - ๐ต๏ธโ๏ธ Enhanced Scout Phase...
23:06:54 - Vector Search: No matches above threshold 0.5
23:06:56 - โ Vector Search yielded no results/failed
23:06:56 - โ Engaging Keyword Fallback (FlexibleSearch)
```

**ูุงุฐุง ุญุฏุซ:**
1. **ุงุณุชุฎุฑุงุฌ ุงูููุงูุงุช:** ูุดู ูู ุงุณุชุฎุฑุงุฌ ุฃุฑูุงู ุงูููุงุฏ ุฃู ุฃุณูุงุก ุงูุฃูุธูุฉ
2. **Vector Search ุงูุฃูู:** ูุดู (ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููู 0.5)
3. **Keyword Fallback:** ุงุณุชุฎุฏู ุงูุจุญุซ ุงููุตู ุงูุนุงุฏู

**Keyword Query ุงููุณุชุฎุฏู:**
```sql
SELECT * FROM document_chunks
WHERE country_id = 'ุงูุณุนูุฏูุฉ'
AND (
  content ILIKE '%ูุง%' OR
  content ILIKE '%ูู%' OR
  content ILIKE '%ุงูููุงุฏ%' OR
  content ILIKE '%ุงูุชู%' OR
  content ILIKE '%ุชุชููู%'
)
LIMIT 10
```

**โ ุงููุดููุฉ:** ุงูุจุญุซ ุนู ูููุงุช ุดุงุฆุนุฉ ุฌุฏุงู ("ูุง"ุ "ูู")!
- ูุฐู ูููุงุช ููุฌูุฏุฉ ูู **ูู** ูุต ูุงูููู
- ุงููุชูุฌุฉ: ูุฌุฏ ูุตูุต ุนุดูุงุฆูุฉ (ุงูุทูุฑุงูุ ุงูููุงุฌู)

---

### ุงููุฑุญูุฉ 2: Scout Results (ุงุณุชุฎุฑุงุฌ ุงููููุงุช ุงูููุชุงุญูุฉ)
```
23:07:06 - Scout Results:
Keywords = ['ุงููุงุฏุฉ ุงูุณุงุจุนุฉ', 'ุงููุงุฏุฉ ุงูุซุงูุซุฉ ูุงูุซูุงุซูู', ...]
ูู ูุธุงู ุงูุทูุฑุงู ุงููุฏูู ููุธุงู ุงูููุงุฌู!
```

**ูุงุฐุง ุญุฏุซ:**
- ุงููุธุงู ุงุณุชุฎุฑุฌ ูููุงุช ูู ุงููุชุงุฆุฌ ุงูุฎุงุทุฆุฉ
- ุฃุตุจุญ ุงูุขู ูุจุญุซ ุนู **ุงูุทูุฑุงู** ุจุฏูุงู ูู **ุงููุจุฉ**!

---

### ุงููุฑุญูุฉ 3: Precision Sniper Phase
```
23:07:06 - ๐ฏ Precision Sniper Phase...
23:07:08 - โ VectorSearch: Found 10 matches
23:07:15 - โ FlexibleSearch: Found 40 results
```

**ูุงุฐุง ุญุฏุซ:**
- Vector Search ุงูุซุงูู ูุฌุญ (ุจูููุงุช ุฎุงุทุฆุฉ)
- ูุฌุฏ 50 ูุชูุฌุฉ ุฅุฌูุงูุงู (ููู ุนู ุงูุทูุฑุงู!)

---

## ๐ฏ ุงูุญู ุงูููุชุฑุญ:

### 1. ุชุญุณูู ุงุณุชุฎุฑุงุฌ ุงููููุงุช ุงูููุชุงุญูุฉ
```python
# ุงูุญุงูู (ุฎุงุทุฆ):
keywords = ["ูุง", "ูู", "ุงูููุงุฏ", "ุงูุชู", "ุชุชููู"]

# ุงููุทููุจ (ุตุญูุญ):
keywords = ["ุงููุจุฉ", "ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ"]
```

### 2. ุชูููู threshold ููู Vector Search
```python
# ุงูุญุงูู:
threshold = 0.5  # ูุฑุชูุน ุฌุฏุงู

# ุงูููุชุฑุญ:
threshold = 0.3  # ุฃูุซุฑ ูุฑููุฉ
```

### 3. ุงุณุชุฎุฏุงู Stop Words
```python
STOP_WORDS = ["ูุง", "ูู", "ูู", "ุนู", "ูู", "ุฅูู", "ุนูู"]
# ุฅุฒุงูุชูุง ูุจู ุงูุจุญุซ
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงูุจุญุซ ุงููุจุงุดุฑ:

### Test 1: ุงูุจุญุซ ุนู "ุงููุจุฉ"
```python
import asyncio
from agents.tools.hybrid_search_tool import HybridSearchTool

async def test_gift_search():
    search_tool = HybridSearchTool()
    
    # ุงูุจุญุซ ุงููุจุงุดุฑ
    result = await search_tool.run(
        query="ุงููุจุฉ",
        limit=10,
        country_id="sa"  # ุงูุณุนูุฏูุฉ
    )
    
    print(f"โ ูุฌุฏ {len(result.data)} ูุชูุฌุฉ")
    for item in result.data:
        print(f"- {item.get('ai_summary', 'No summary')[:100]}")
    
    return result

# ุชุดุบูู
asyncio.run(test_gift_search())
```

### Test 2: ุงูุจุญุซ ุงููุฑูุจ
```python
async def test_civil_transactions_gift():
    search_tool = HybridSearchTool()
    
    # ุงูุจุญุซ ุนู "ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ + ุงููุจุฉ"
    result = await search_tool.run(
        query="ุงููุจุฉ ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ",
        limit=10,
        country_id="sa"
    )
    
    print(f"โ ูุฌุฏ {len(result.data)} ูุชูุฌุฉ ุนู ุงููุจุฉ ูู ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ")
    
    return result

asyncio.run(test_civil_transactions_gift())
```

### Test 3: ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช
```python
from config.database import db

def check_civil_transactions_system():
    # ุงูุจุญุซ ูู legal_sources
    result = db.client.from_("legal_sources").select("id, title").ilike("title", "%ูุนุงููุงุช%ูุฏููุฉ%").execute()
    
    if result.data:
        print(f"โ ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ ููุฌูุฏ:")
        for doc in result.data:
            print(f"  - {doc['title']}")
            
            # ุงูุจุญุซ ุนู chunks ุชุญุชูู "ูุจุฉ"
            chunks = db.client.from_("document_chunks").select("id, ai_summary").eq("source_id", doc['id']).ilike("content", "%ูุจุฉ%").limit(5).execute()
            
            if chunks.data:
                print(f"    โ ูุฌุฏ {len(chunks.data)} chunks ุนู ุงููุจุฉ")
            else:
                print(f"    โ ูุง ุชูุฌุฏ chunks ุนู ุงููุจุฉ")
    else:
        print("โ ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช!")

check_civil_transactions_system()
```

---

## ๐ ุงูุฎูุงุตุฉ:

### ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:
1. โ **Scout Phase** ุจุญุซ ุนู ูููุงุช ุดุงุฆุนุฉ ("ูุง"ุ "ูู")
2. โ **ุงุณุชุฎุฑุฌ ูููุงุช ุฎุงุทุฆุฉ** ูู ูุชุงุฆุฌ ุบูุฑ ุฐุงุช ุตูุฉ
3. โ **Precision Phase** ุจุญุซ ุจูุงุกู ุนูู ูููุงุช ุฎุงุทุฆุฉ

### ุงูุญู:
1. โ ุชุญุณูู **Keyword Extraction** (ุฅุฒุงูุฉ Stop Words)
2. โ ุชูููู **Vector Threshold** ูู 0.5 ุฅูู 0.3
3. โ ุฅุนุทุงุก ุฃููููุฉ ูููููุงุช **ุงูุฃุณุงุณูุฉ** ("ุงููุจุฉ") ุนูู ุงููููุงุช **ุงูุดุงุฆุนุฉ** ("ูุง")

### ุงูุฎุทูุฉ ุงูุชุงููุฉ:
ุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุฃุนูุงู ููุชุญูู ูู:
- ูู "ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ" ููุฌูุฏุ
- ูู ูุญุชูู ุนูู ูููุฉ "ูุจุฉ"ุ
- ููุงุฐุง Vector Search ูุดูุ
"""
