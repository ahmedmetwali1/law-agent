# ๐ด ุงูุชุญููู ุงูุฌุฐุฑู: ููุงุฐุง ูุธุงู ุงูุจุญุซ ูุงุดูุ

**ุงูุชุงุฑูุฎ:** 2026-02-05  
**ุงูุญุงูุฉ:** ๐ด ูุดู ูุนูุงุฑู ูุงูู  
**ุงูุฃููููุฉ:** ุญุฑุฌุฉ - ุฅุนุงุฏุฉ ุชุตููู ูุงููุฉ ูุทููุจุฉ

---

## ๐ **ุงูุญูููุฉ ุงูููุฑูุฉ:**

### ุงููุดููุฉ ููุณุช ูู ุงูููุฏ - ุฅููุง ูู **ุงูููุฑุฉ ุจุฃููููุง**

ุงูุธุฑ ูููุชุงุฆุฌ:

```
SQL Search: ูุฌุฏ "ุงููุจุฉ" โ
ููู ูู ุฃู ุณูุงูุ

ุงููุชูุฌุฉ #1:
"ุงููุงุฏุฉ ุงูุซุงูุซุฉ: ุชูุนูู ูู ุงูุถุฑูุจุฉ... ุงูุชุตุฑู ุงูุนูุงุฑู - ุฏูู ููุงุจู - ูู ุงูุฃุตูู ูููุฑูุน ุฃู ููุฒูุฌุ ุฃู ููููู ุฃู ุงููุจุฉ ุจููุฏุงุฑ..."
                                                                                           โฌ๏ธ
                                                                            ุงููุจุฉ ูู ุณูุงู ุงูุถุฑุงุฆุจ!

ุงููุณุชุฎุฏู ูุณุฃู: "ูุง ูู ุงููุจุฉุ" (ูุฑูุฏ ุงูุชุนุฑูู ุงููุงูููู)
ุงููุธุงู ููุฌูุจ: "ุฅุนูุงุก ุถุฑูุจู ุนูู ุงููุจุฉ" โโโ
```

---

## ๐ **ููุงุฐุง ูุดูุช ูู ุงูุฃุฏูุงุชุ**

### 1. **SQL/FlexibleSearchTool - ุจุฏุงุฆู ุฌุฏุงู**

```python
# โ ุงูููุฏ ุงูุญุงูู:
SELECT * FROM chunks WHERE content ILIKE '%ุงููุจุฉ%'

# ุงููุดููุฉ:
# ูุฌุฏ ุงููููุฉ โ
# ููู ูู ุฃู ุณูุงูุ โ
#   - "ุงููุจุฉ ูู ุงูุถุฑุงุฆุจ" โ
#   - "ุงููุจุฉ ูู ุงููุงููู ุงููุฏูู" โ
#   - "ุงููุจุฉ ูู ุงููุตูุฉ" โ
```

**ุงูุชูููู:** Keyword matching ุจูุง ููู = ุนุฏูู ุงููุงุฆุฏุฉ ูููุงููู

### 2. **VectorSearchTool - Embeddings ุถุนููุฉ**

```
Similarity Scores:
- ูุธุงู ูุธุงุฆู ุงูุฃููุงู: 0.3196
- ูุฌูุณ ุฅุฏุงุฑุฉ ุงูููุฆุฉ: 0.3177
- ุงูุทูู ุงูุชุฑุฏุฏู: 0.3113

ูููุง ~0.31 = ุนุดูุงุฆู ุชูุงูุงู!
```

**ุงูุณุจุจ:**
- `text-embedding-3-small` (1024 dimensions) **ููุณ ููุฏุฑูุจ ุนูู ุงููุงููู ุงูุนุฑุจู**
- ูุง ูููู ุงููุฑู ุจูู "ุชุนุฑูู ุงููุจุฉ" ู "ุถุฑูุจุฉ ุงููุจุฉ"
- ุงูู Chunking ุฎุงุทุฆ (500-1500 ูููุฉ = ุณูุงู ููุฎุชูุท)

### 3. **HybridSearchTool - Scoring ูููุชุฑุฆ**

```python
# ุงููุดููุฉ ุงูุฃุณุงุณูุฉ:
final_score = (
    base_similarity * 0.30 +      # 0.31 (ุนุดูุงุฆู)
    norm_entity_score * 0.20 +    # 0.0 (ูุง ููุงุฏ)
    norm_keyword_score * 0.20 +   # 0.8 (ูุฌุฏ "ุงููุจุฉ" + "ุชุนุฑูู")
    type_bonus * 0.30             # 0.7 (ูุฌุฏ "ุชุนุฑูู")
)

# ุงููุชูุฌุฉ:
# ูุณุชูุฏ ุนู ุงูุถุฑุงุฆุจ ูุญุชูู ุนูู:
#   - "ุงููุจุฉ" โ
#   - "ุชูุนูู" (ููุดุจู "ุชุนุฑูู"!) โ
#   - Score: 0.43 โโโ โ ุฃุนูู ููุงุท!

# ูุณุชูุฏ ุงูุชุนุฑูู ุงูุญูููู:
#   - "ุงููุจุฉ" โ
#   - "ุชุนุฑูู" โ
#   - ููู Embedding ุถุนูู (0.25)
#   - Score: 0.30 โ ูุฎุณุฑ!
```

---

## ๐ฏ **ุงูุณุจุจ ุงูุฌุฐุฑู (Root Cause):**

### โ **ุงูุงูุชุฑุงุถ ุงูุฎุงุทุฆ:**

> "ุฅุฐุง ูุฌุฏูุง ุงููููุฉ ุงูููุชุงุญูุฉ + ุจุนุถ ุงููููุงุช ุฐุงุช ุงูุตูุฉุ ูููู ูุฌุฏูุง ุงูุฅุฌุงุจุฉ"

### โ **ุงููุงูุน:**

> "ุงููุงููู ูุนุชูุฏ ุนูู **ุงูุณูุงู ุงูุฏููู** - ุงููุงุฏุฉ 100 ุนู ุงููุจุฉ ูู ุงููุงููู ุงููุฏูู โ ุงููุงุฏุฉ 5 ุนู ุงููุจุฉ ูู ูุงููู ุงูุถุฑุงุฆุจ"

---

## ๐ **ุชุญููู ุงููุดุงูู ุงููููููุฉ:**

| ุงููููู | ุงููุดููุฉ | ุงูุชุฃุซูุฑ |
|--------|---------|---------|
| **Chunking** | 500-1500 ูููุฉ = ุณูุงูุงุช ููุฎุชูุทุฉ | ุงูุดุฑูุญุฉ ุชุญุชูู "ุงููุจุฉ" ูู 3 ุณูุงูุงุช ูุฎุชููุฉ |
| **Embeddings** | ูููุฐุฌ ุนุงู (ุบูุฑ ูุงูููู) | ูุง ููุฑูู ุจูู "ุชุนุฑูู" ู "ุถุฑูุจุฉ" |
| **Scoring** | Keyword matching ุจุฏุงุฆู | "ุงููุจุฉ" + "ุชุนุฑูู" = ููุงุท ุนุงููุฉ (ุฃูุงู ูุงู ุงูุณูุงู!) |
| **Re-ranking** | ุบูุฑ ููุฌูุฏ! | ูุง ุชูุฌุฏ ุทุจูุฉ ูุฅุนุงุฏุฉ ุชูููู ุงููุชุงุฆุฌ |
| **Query Understanding** | LLM ูููููุฏ keywords ููุท | ูุง ูููู Intent ุงูุญูููู |

---

## ๐ง **ุงูุญููู ุงูููููุฉ (ููุฑุชุจุฉ ุญุณุจ ุงููุนุงููุฉ):**

### ุงูุญู #1: ๐ซ **Abandon Ship** (ุงูุชุฎูู ุนู ุงููุธุงู ุงูุญุงูู)

**ุงูุงุณุชุฑุงุชูุฌูุฉ:** ุฅุนุงุฏุฉ ุจูุงุก ูู ุงูุตูุฑ

```python
# Architecture ุงูุฌุฏูุฏ:
1. Query Understanding (LLM)
   โ
2. Intent Classification: DEFINITION | ARTICLE_LOOKUP | CASE_ANALYSIS
   โ
3. Specialized Retrievers:
   - DefinitionRetriever โ ูุจุญุซ ูู "ุจุงุจ ุงูุชุนุฑููุงุช"
   - ArticleRetriever โ ูุจุญุซ ุนู ุฑูู ูุงุฏุฉ ููุญุฏุฏ
   - CaseRetriever โ ูุจุญุซ ุนู ูุถุงูุง ููุดุงุจูุฉ
   โ
4. Cross-Encoder Re-ranking (ุถุฑูุฑู!)
   โ
5. LLM Synthesis (ูุน Citations)
```

**ุงูููุช:** 2-3 ุฃุณุงุจูุน  
**ุงููุฌุงุญ ุงูููุชููุน:** 85%+

---

### ุงูุญู #2: ๐ง **Emergency Patch** (ุชุฑููุน ุทุงุฑุฆ)

**ุงูุงุณุชุฑุงุชูุฌูุฉ:** ุงุณุชุฎุฏุงู LLM ููู ุดูุก (Bypass ุงูุฃุฏูุงุช)

```python
async def emergency_search(query: str):
    # 1. LLM ูููุฑุฑ ุงูุงุณุชุฑุงุชูุฌูุฉ
    strategy = await llm.ainvoke(f"""
    Query: {query}
    
    What is the user asking for?
    A) Definition of a legal term
    B) Specific article number
    C) Legal procedure
    D) Case analysis
    
    Output: A/B/C/D + Keywords
    """)
    
    # 2. ุงุณุชุนูุงู SQL ููุจุงุดุฑ (ุจุฏูู embeddings!)
    if strategy == 'A':  # Definition
        sql = f"""
        SELECT * FROM document_chunks
        WHERE content ILIKE '%ุชุนุฑูู%{query_term}%'
           OR content ILIKE '%{query_term} ูู%'
           OR content ILIKE '%{query_term} ูู%'
        ORDER BY sequence_number
        LIMIT 10
        """
    
    # 3. LLM ูููุฎูุต ุงููุชุงุฆุฌ
    results = db.execute(sql)
    answer = await llm.ainvoke(f"Summarize: {results}")
    
    return answer
```

**ุงูููุช:** 1-2 ุฃูุงู  
**ุงููุฌุงุญ ุงูููุชููุน:** 60%  
**ุงูุนููุจ:** ุจุทูุกุ ูููููุ ุบูุฑ ูุงุจู ููุชูุณุน

---

### ุงูุญู #3: ๐ฏ **Hybrid Pragmatic** (ุญู ูุฌูู ุนููู)

**ุงูุงุณุชุฑุงุชูุฌูุฉ:** ุฅุตูุงุญุงุช ููุฑููุฒุฉ + LLM Re-ranking

#### **Phase 1: ุฅุตูุงุญ ุงูู Chunking (3 ุฃูุงู)**

```python
# โ Current Chunking:
# Chunk #1: [ุงููุงุฏุฉ 1, ุงููุงุฏุฉ 2, ุงููุงุฏุฉ 3, ...]  โ mixed context

# โ New Chunking:
# Chunk #1: [ุนููุงู ุงูุจุงุจ + ุงููุงุฏุฉ 1 ููุท]
# Chunk #2: [ุงููุงุฏุฉ 2 ููุท]
# Chunk #3: [ุงููุงุฏุฉ 3 ููุท]

# Result: ูู chunk = ุณูุงู ูุงุญุฏ ูุงุถุญ
```

#### **Phase 2: LLM Re-ranker (2 ุฃูุงู)**

```python
async def llm_rerank(query: str, candidates: List[Dict]):
    """
    ุงุณุชุฎุฏุงู LLM ูุฅุนุงุฏุฉ ุชุฑุชูุจ ุงููุชุงุฆุฌ ุจูุงุกู ุนูู ุงูุณูุงู
    """
    prompt = f"""
    User Question: {query}
    
    Rank these legal chunks by relevance (1-10):
    
    {format_candidates(candidates)}
    
    Output JSON: [{{"id": "...", "score": 8}}, ...]
    """
    
    reranked = await llm.ainvoke(prompt, json_mode=True)
    return reranked
```

#### **Phase 3: Intent-Aware Retrieval (3 ุฃูุงู)**

```python
# ููุชุนุฑููุงุช:
SELECT * FROM chunks
WHERE hierarchy_path LIKE '%ุจุงุจ ุงูุชุนุฑููุงุช%'
   OR content ILIKE '%ุชุนุฑูู ุงููุจุฉ%'

# ููููุงุฏ:
SELECT * FROM chunks
WHERE content ILIKE '%ุงููุงุฏุฉ {article_number}%'
  AND source_id IN (SELECT id FROM legal_sources WHERE doc_type = 'ูุงููู ูุฏูู')

# ููุฅุฌุฑุงุกุงุช:
SELECT * FROM chunks
WHERE hierarchy_path LIKE '%ุจุงุจ ุงูุฅุฌุฑุงุกุงุช%'
   OR keywords @> ARRAY['ุฅุฌุฑุงุกุงุช', 'ุฎุทูุงุช']
```

**ุงูููุช ุงูุฅุฌูุงูู:** 1 ุฃุณุจูุน  
**ุงููุฌุงุญ ุงูููุชููุน:** 75%

---

## ๐งช **ุงุฎุชุจุงุฑ ุงูุญู ุงูุทุงุฑุฆ (ุงูุขู):**

ุฏุนูู ุฃุจูู proof-of-concept ููุญู #2:

```python
async def emergency_hiba_search():
    """
    ุจุญุซ ุนู 'ุงููุจุฉ' ุจุฏูู HybridSearchTool
    ุงุณุชุฎุฏุงู LLM + SQL ูุจุงุดุฑ
    """
    # 1. LLM ููุญุฏุฏ Intent
    intent_prompt = """
    ุงููุณุชุฎุฏู ุณุฃู: "ูุง ูู ุงููุจุฉุ"
    
    ูู ูุฑูุฏ:
    A) ุชุนุฑูู ูุงูููู ูููุจุฉ (ูู ุงููุงููู ุงููุฏูู)
    B) ุฅุฌุฑุงุกุงุช ุงููุจุฉ
    C) ุถุฑุงุฆุจ ุงููุจุฉ
    D) ููุงุฏ ูุงููููุฉ ูุนููุฉ ุนู ุงููุจุฉ
    
    ุงูุฅุฌุงุจุฉ: A (ุชุนุฑูู)
    
    ุงููููุงุช ุงูููุชุงุญูุฉ ููุจุญุซ:
    - "ุชุนุฑูู ุงููุจุฉ"
    - "ุงููุจุฉ ูู"
    - "ุนูุฏ ุงููุจุฉ"
    - "ุงููุงูุจ ูุงูููููุจ ูู"
    """
    
    # 2. SQL Pattern Matching ุงูุฐูู
    patterns = [
        "ุชุนุฑูู%ุงููุจุฉ",
        "ุงููุจุฉ%ูู",
        "ุงููุจุฉ%ุนูุฏ",
        "ุนูุฏ%ุงููุจุฉ"
    ]
    
    sql_conditions = " OR ".join([
        f"content ILIKE '%{p}%'" for p in patterns
    ])
    
    sql = f"""
    SELECT id, content, source_id, sequence_number
    FROM document_chunks
    WHERE ({sql_conditions})
      AND content NOT ILIKE '%ุถุฑูุจุฉ%'  -- exclude tax docs
      AND content NOT ILIKE '%ุฅุนูุงุก%'   -- exclude exemptions
    ORDER BY 
      CASE 
        WHEN content ILIKE '%ุชุนุฑูู ุงููุจุฉ%' THEN 1
        WHEN content ILIKE '%ุงููุจุฉ ูู%' THEN 2
        ELSE 3
      END,
      sequence_number
    LIMIT 5
    """
    
    results = db.execute(sql)
    
    # 3. LLM ูููุฎูุต
    summary_prompt = f"""
    ุจูุงุกู ุนูู ูุฐู ุงููุตูุต ุงููุงููููุฉุ ุงุดุฑุญ ูุง ูู ุงููุจุฉ:
    
    {format_results(results)}
    
    ูุฏูู:
    1. ุชุนุฑูู ูุงุถุญ
    2. ุฑูู ุงููุงุฏุฉ ุฅู ููุฌุฏ
    3. ุงูุดุฑูุท ุงูุฃุณุงุณูุฉ
    """
    
    answer = await llm.ainvoke(summary_prompt)
    return answer
```

---

## ๐ **ุงูุชูุตูุฉ ุงูููุงุฆูุฉ:**

### โก **ุงูุขู (ุงูููู):**
- โ ุงุณุชุฎุฏู **FlexibleSearchTool** ุจุฏูุงู ูู HybridSearchTool
- โ ุฃุถู ููุชุฑ `NOT ILIKE '%ุถุฑูุจุฉ%'` ููุงุณุชุจุนุงุฏ
- โ ุงุฌุนู LLM ูููุฎูุต ุงููุชุงุฆุฌ (ุญุชู ูู ุฎุงุทุฆุฉุ ุงูููุฎุต ุฃูุถู)

### ๐ง **ุงูุฃุณุจูุน ุงููุงุฏู:**
- ุชูููุฐ **Hybrid Pragmatic** (ุงูุญู #3)
- Re-chunking (ูุงุฏุฉ ูุงุญุฏุฉ = chunk ูุงุญุฏ)
- LLM Re-ranker

### ๐ **ุงูุดูุฑ ุงููุงุฏู:**
- ุจูุงุก ูุธุงู ุฌุฏูุฏ (ุงูุญู #1)
- Fine-tune Embeddings ุนูู ุงููุงููู ุงูุณุนูุฏู
- Cross-Encoder ููู Re-ranking

---

## ๐ก **ุงูุฏุฑุณ ุงูููุณุชูุงุฏ:**

> **"ุงููุงููู ููุณ ุจุญุซ ุนู ูููุงุช - ุฅูู ููู ููุณูุงู"**

ุงููุธุงู ุงูุญุงูู ูุจุญุซ ุนู "ุงููุจุฉ" ููุง ุชุจุญุซ Google.  
ููู ุงููุงููู ูุญุชุงุฌ ููู **ุฃูู** ู **ููุงุฐุง** ุฐููุฑุช ุงููุจุฉ.

**ุงูุฎูุงุตุฉ:** Embeddings + Keyword Matching = ููุณูุง ูุงูููู ูููุงููู.

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2026-02-05 21:12  
**ุงูุญุงูุฉ:** ๐ด ูุธุงู ูุนุทูุจ - ูุญุชุงุฌ ุฅุนุงุฏุฉ ุชุตููู ููุฑูุฉ  
**ุงููุณุคูู:** ูุฑูู ุชุทููุฑ Marid AI - Search Architecture Team
