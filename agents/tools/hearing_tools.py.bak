"""
Hearing Management Tools for AI Agent
أدوات إدارة الجلسات للوكيل الذكي
"""

from typing import Dict, Any, List, Optional
from datetime import date, time, datetime
import logging

from agents.storage.hearing_storage import hearing_storage

logger = logging.getLogger(__name__)


class HearingTools:
    """Tools for managing hearings"""
    
    def __init__(self, lawyer_id: str):
        """
        Initialize hearing tools
        
        Args:
            lawyer_id: Lawyer's user ID
        """
        self.lawyer_id = lawyer_id
        self.storage = hearing_storage
        logger.info(f"✅ HearingTools initialized for lawyer {lawyer_id}")
    
    def get_tools_list(self) -> List[Dict[str, Any]]:
        """Get list of available tools"""
        return [
            {
                "name": "get_today_hearings",
                "description": """
                عرض جلسات اليوم للمحامي.
                استخدم هذه الأداة عندما يسأل المحامي: "ما جلساتي اليوم؟"
                
                Returns:
                    قائمة جلسات اليوم مع تفاصيل القضية والموكل
                """,
                "function": self.get_today_hearings
            },
            {
                "name": "get_upcoming_hearings",
                "description": """
                عرض الجلسات القادمة (الأسبوع القادم).
                
                Args:
                    days: عدد الأيام للمستقبل (افتراضي: 7)
                
                Returns:
                    قائمة الجلسات القادمة
                """,
                "function": self.get_upcoming_hearings
            },
            {
                "name": "create_hearing",
                "description": """
                إنشاء جلسة جديدة لقضية.
                
                Args:
                    case_id: معرف القضية (UUID)
                    hearing_date: تاريخ الجلسة (YYYY-MM-DD)
                    hearing_time: وقت الجلسة (HH:MM) اختياري
                    court_room: رقم القاعة (اختياري)
                    judge_name: اسم القاضي (اختياري)
                    notes: ملاحظات (اختياري)
                
                Returns:
                    معلومات الجلسة المُنشأة
                """,
                "function": self.create_hearing
            },
            {
                "name": "get_case_hearings",
                "description": """
                عرض جميع جلسات قضية معينة.
                
                Args:
                    case_id: معرف القضية
                
                Returns:
                    قائمة الجلسات مرتبة حسب التاريخ
                """,
                "function": self.get_case_hearings
            },
            {
                "name": "update_hearing_outcome",
                "description": """
                تحديث نتيجة الجلسة بعد انتهائها.
                
                Args:
                    hearing_id: معرف الجلسة
                    outcome: نتيجة الجلسة
                    next_hearing_date: تاريخ الجلسة القادمة (اختياري)
                    notes: ملاحظات إضافية (اختياري)
                
                Returns:
                    البيانات المحدثة
                """,
                "function": self.update_hearing_outcome
            }
        ]
    
    def get_today_hearings(self) -> Dict[str, Any]:
        """Get today's hearings for the lawyer"""
        try:
            hearings = self.storage.get_today_hearings_by_lawyer(self.lawyer_id)
            
            if not hearings:
                return {
                    "success": True,
                    "count": 0,
                    "hearings": [],
                    "message": "ليس لديك جلسات اليوم"
                }
            
            # Format response with case and client info
            formatted_hearings = []
            for hearing in hearings:
                case_data = hearing.get("cases", {})
                client_data = case_data.get("clients", {})
                
                formatted_hearings.append({
                    "hearing_time": hearing.get("hearing_time"),
                    "court_room": hearing.get("court_room"),
                    "case_number": case_data.get("case_number"),
                    "client_name": client_data.get("full_name"),
                    "court_name": case_data.get("court_name"),
                    "judge_name": hearing.get("judge_name"),
                    "notes": hearing.get("notes")
                })
            
            return {
                "success": True,
                "count": len(hearings),
                "date": date.today().isoformat(),
                "hearings": formatted_hearings,
                "message": f"لديك {len(hearings)} جلسة اليوم"
            }
        except Exception as e:
            logger.error(f"Failed to get today's hearings: {e}")
            return {
                "success": False,
                "error": str(e),
                "hearings": []
            }
    
    def get_upcoming_hearings(self, days: int = 7) -> Dict[str, Any]:
        """Get upcoming hearings"""
        try:
            hearings = self.storage.get_upcoming_hearings_by_lawyer(
                lawyer_id=self.lawyer_id,
                days=days
            )
            
            return {
                "success": True,
                "count": len(hearings),
                "hearings": hearings,
                "message": f"لديك {len(hearings)} جلسة قادمة في الأيام الـ {days} القادمة"
            }
        except Exception as e:
            logger.error(f"Failed to get upcoming hearings: {e}")
            return {
                "success": False,
                "error": str(e),
                "hearings": []
            }
    
    def create_hearing(
        self,
        case_id: str,
        hearing_date: str,  # YYYY-MM-DD
        hearing_time: Optional[str] = None,  # HH:MM
        court_room: Optional[str] = None,
        judge_name: Optional[str] = None,
        judge_requests: Optional[str] = None,
        notes: Optional[str] = None
    ) -> Dict[str, Any]:
        """Create new hearing"""
        try:
            # Parse date and time
            date_obj = datetime.strptime(hearing_date, "%Y-%m-%d").date()
            time_obj = None
            if hearing_time:
                time_obj = datetime.strptime(hearing_time, "%H:%M").time()
            
            hearing = self.storage.create_hearing(
                case_id=case_id,
                hearing_date=date_obj,
                hearing_time=time_obj,
                court_room=court_room,
                judge_name=judge_name,
                judge_requests=judge_requests,
                notes=notes
            )
            
            return {
                "success": True,
                "hearing": hearing,
                "message": f"تم إضافة جلسة بتاريخ {hearing_date}"
            }
        except Exception as e:
            logger.error(f"Failed to create hearing: {e}")
            return {
                "success": False,
                "error": str(e),
                "message": f"فشل في إضافة الجلسة: {str(e)}"
            }
    
    def get_case_hearings(self, case_id: str) -> Dict[str, Any]:
        """Get all hearings for a case"""
        try:
            hearings = self.storage.get_case_hearings(case_id)
            
            return {
                "success": True,
                "count": len(hearings),
                "hearings": hearings,
                "message": f"القضية لديها {len(hearings)} جلسة"
            }
        except Exception as e:
            logger.error(f"Failed to get case hearings: {e}")
            return {
                "success": False,
                "error": str(e),
                "hearings": []
            }
    
    def update_hearing_outcome(
        self,
        hearing_id: str,
        outcome: str,
        next_hearing_date: Optional[str] = None,
        notes: Optional[str] = None
    ) -> Dict[str, Any]:
        """Update hearing outcome"""
        try:
            updates = {"outcome": outcome}
            
            if next_hearing_date:
                updates["next_hearing_date"] = next_hearing_date
            
            if notes:
                updates["notes"] = notes
            
            hearing = self.storage.update_hearing(hearing_id, updates)
            
            if not hearing:
                return {
                    "success": False,
                    "message": "لم يتم العثور على الجلسة"
                }
            
            return {
                "success": True,
                "hearing": hearing,
                "message": "تم تحديث نتيجة الجلسة"
            }
        except Exception as e:
            logger.error(f"Failed to update hearing: {e}")
            return {
                "success": False,
                "error": str(e)
            }


__all__ = ["HearingTools"]
