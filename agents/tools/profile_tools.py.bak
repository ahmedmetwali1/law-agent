"""
Profile Management Tools for AI Agent
أدوات إدارة بيانات المحامي للوكيل الذكي
"""

from typing import Dict, Any, List, Optional
import logging

from agents.storage.user_storage import user_storage

logger = logging.getLogger(__name__)


class ProfileTools:
    """Tools for managing lawyer profile (excluding password)"""
    
    def __init__(self, lawyer_id: str):
        """
        Initialize profile tools
        
        Args:
            lawyer_id: Lawyer's user ID
        """
        self.lawyer_id = lawyer_id
        self.storage = user_storage
        logger.info(f"✅ ProfileTools initialized for lawyer {lawyer_id}")
    
    def get_tools_list(self) -> List[Dict[str, Any]]:
        """Get list of available tools"""
        return [
            {
                "name": "get_my_profile",
                "description": """
                عرض بيانات المحامي الشخصية.
                استخدم هذا عندما يسأل المحامي عن بياناته.
                
                Returns:
                    بيانات المحامي (بدون كلمة المرور)
                """,
                "function": self.get_my_profile
            },
            {
                "name": "update_my_profile",
                "description": """
                تعديل بيانات المحامي.
                ملاحظة: لا يمكن تعديل كلمة المرور من هنا.
                
                Args:
                    updates: الحقول المراد تحديثها (full_name, phone, email, office_id)
                
                Returns:
                    البيانات المحدثة
                """,
                "function": self.update_my_profile
            }
        ]
    
    def get_my_profile(self) -> Dict[str, Any]:
        """Get lawyer's profile"""
        try:
            user = self.storage.get_user_by_id(self.lawyer_id)
            
            if not user:
                return {
                    "success": False,
                    "message": "لم يتم العثور على البيانات"
                }
            
            # Remove sensitive data
            user.pop("password_hash", None)
            
            return {
                "success": True,
                "profile": user,
                "message": f"مرحباً {user['full_name']}"
            }
        except Exception as e:
            logger.error(f"Failed to get profile: {e}")
            return {
                "success": False,
                "error": str(e)
            }
    
    def update_my_profile(self, updates: Dict[str, Any]) -> Dict[str, Any]:
        """
        Update lawyer profile
        
        Note: Password cannot be changed via this tool
        """
        try:
            # Remove password-related fields if present
            forbidden_fields = ["password", "password_hash", "id", "role", "is_active"]
            for field in forbidden_fields:
                if field in updates:
                    updates.pop(field)
            
            if not updates:
                return {
                    "success": False,
                    "message": "لا توجد حقول للتحديث"
                }
            
            user = self.storage.update_user(self.lawyer_id, updates)
            
            if not user:
                return {
                    "success": False,
                    "message": "فشل التحديث"
                }
            
            # Remove sensitive data
            user.pop("password_hash", None)
            
            return {
                "success": True,
                "profile": user,
                "message": "تم تحديث بياناتك بنجاح"
            }
        except Exception as e:
            logger.error(f"Failed to update profile: {e}")
            return {
                "success": False,
                "error": str(e),
                "message": f"فشل التحديث: {str(e)}"
            }


__all__ = ["ProfileTools"]
