"""
Case Management Tools for AI Agent
Ø£Ø¯ÙˆØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ù„Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
"""

from typing import Dict, Any, List, Optional
from datetime import date
import logging

from agents.storage.case_storage import CaseStorage

logger = logging.getLogger(__name__)


class CaseTools:
    """Tools for managing cases with client relationship"""
    
    def __init__(self, lawyer_id: str):
        """
        Initialize case tools
        
        Args:
            lawyer_id: Lawyer's user ID
        """
        self.lawyer_id = lawyer_id
        self.storage = CaseStorage()
        logger.info(f"âœ… CaseTools initialized for lawyer {lawyer_id}")
    
    def get_tools_list(self) -> List[Dict[str, Any]]:
        """Get list of available tools"""
        return [
            {
                "name": "create_case",
                "description": """
                Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…ÙˆÙƒÙ„.
                
                Args:
                    client_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆÙƒÙ„ (UUID) - Ø¥Ù„Ø²Ø§Ù…ÙŠ
                    case_number: Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ© - Ø¥Ù„Ø²Ø§Ù…ÙŠ
                    court_name: Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙƒÙ…Ø© (Ù…Ø«Ù„: Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ø±ÙŠØ§Ø¶) - Ø¥Ù„Ø²Ø§Ù…ÙŠ
                    case_type: Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ© (Ù…Ø«Ù„: Ù…Ø¯Ù†ÙŠØŒ Ø¬Ø²Ø§Ø¦ÙŠØŒ ØªØ¬Ø§Ø±ÙŠ)
                    subject: Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ©
                    client_capacity: ØµÙØ© Ø§Ù„Ù…ÙˆÙƒÙ„ (Ù…Ø¯Ø¹ÙŠ Ø£Ùˆ Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡)
                    case_year: Ø³Ù†Ø© Ø§Ù„Ù‚Ø¶ÙŠØ©
                    case_date: ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø¶ÙŠØ© (YYYY-MM-DD)
                    summary: Ù…Ù„Ø®Øµ Ø§Ù„Ù‚Ø¶ÙŠØ©
                    court_circuit: Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ø­ÙƒÙ…Ø©
                    status: Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¶ÙŠØ© (active/closed/pending) - Ø§ÙØªØ±Ø§Ø¶ÙŠ: active
                
                Returns:
                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„Ù…ÙÙ†Ø´Ø£Ø©
                """,
                "function": self.create_case
            },
            {
                "name": "search_cases",
                "description": """
                Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø­Ø³Ø¨ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ù„Ù…Ø­ÙƒÙ…Ø©ØŒ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹.
                
                Args:
                    query: Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
                
                Returns:
                    Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                """,
                "function": self.search_cases
            },
            {
                "name": "get_case_details",
                "description": """
                Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ù‚Ø¶ÙŠØ© Ù…Ø¹ÙŠÙ†Ø© Ù…Ø¹ Ø¬Ù„Ø³Ø§ØªÙ‡Ø§.
                
                Args:
                    case_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø¶ÙŠØ©
                
                Returns:
                    ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø¶ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
                """,
                "function": self.get_case_details
            },
            {
                "name": "list_client_cases",
                "description": """
                Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ù‚Ø¶Ø§ÙŠØ§ Ù…ÙˆÙƒÙ„ Ù…Ø¹ÙŠÙ†.
                
                Args:
                    client_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆÙƒÙ„
                
                Returns:
                    Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…ÙˆÙƒÙ„
                """,
                "function": self.list_client_cases
            },
            {
                "name": "list_active_cases",
                "description": """
                Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„Ù…Ø­Ø§Ù…ÙŠ.
                
                Returns:
                    Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù†Ø´Ø·Ø© (status=active)
                """,
                "function": self.list_active_cases
            },
            {
                "name": "update_case",
                "description": """
                ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¶ÙŠØ©.
                
                Args:
                    case_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø¶ÙŠØ©
                    updates: Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø¯ÙŠØ«Ù‡Ø§
                
                Returns:
                    Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                """,
                "function": self.update_case
            },
            {
                "name": "close_case",
                "description": """
                Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø¶ÙŠØ© (ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ closed).
                
                Args:
                    case_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø¶ÙŠØ©
                    verdict_number: Ø±Ù‚Ù… Ø§Ù„Ø­ÙƒÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    verdict_date: ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙƒÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    summary: Ù…Ù„Ø®Øµ Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                
                Returns:
                    Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                """,
                "function": self.close_case
            }
        ]
    
    
    def _load_schema(self) -> Dict[str, Any]:
        """Load schema definition"""
        try:
            import json
            import os
            # Use absolute path to ensure reliability
            schema_path = r"e:\law\agents\knowledge\datamodel_definition.json"
            if os.path.exists(schema_path):
                with open(schema_path, 'r', encoding='utf-8') as f:
                    return json.load(f)["tables"]["cases"]["columns"]
        except Exception as e:
            logger.warning(f"Could not load schema: {e}")
        return {}

    def create_case(
        self,
        client_id: str,
        case_number: str,
        court_name: str,
        case_type: Optional[str] = None,
        subject: Optional[str] = None,
        client_capacity: Optional[str] = None,
        case_year: Optional[str] = None,
        case_date: Optional[str] = None,
        summary: Optional[str] = None,
        court_circuit: Optional[str] = None,
        status: str = "active"
    ) -> Dict[str, Any]:
        """Create new case with intelligent validation"""
        logger.info("ğŸ› ï¸ Executing intelligent create_case logic...")
        try:
            import uuid
            from agents.utils.text_normalizer import TextNormalizer
            
            # --- 1. INTELLIGENT VALIDATION LAYER ---
            schema = self._load_schema()
            missing_fields = []
            
            # Check mandatory fields based on schema
            fields_to_check = {
                "client_capacity": client_capacity,
                "case_number": case_number,
                "court_name": court_name,
                "subject": subject,
                "case_year": case_year
            }
            
            for field_name, value in fields_to_check.items():
                if field_name in schema and schema[field_name].get("required", False):
                    # If empty or None
                    if not value or str(value).strip() == "":
                        # Try to apply default rules
                        if field_name == "case_year":
                            case_year = str(date.today().year) # Default: Current Year
                        else:
                            missing_message = schema[field_name].get("missing_message", f"Missing {field_name}")
                            missing_fields.append(missing_message)

            if missing_fields:
                # Return 'partial_success' or handled failure requesting more info
                # In agent flow, this usually means return immediate text to user
                return {
                    "success": False,
                    "reason": "missing_information",
                    "message": "âš ï¸ " + "\n".join(missing_fields),
                    "missing_fields": missing_fields
                }

            # --- 2. TEXT NORMALIZATION LAYER ---
            # Normalize entries to ensure consistency
            if subject:
                subject = TextNormalizer.normalize_arabic_text(subject)
            if court_name:
                court_name = TextNormalizer.normalize_arabic_text(court_name)
            
            # --- 3. EXECUTION ---
            
            # First verify client belongs to this lawyer
            from agents.storage.client_storage import client_storage
            client = client_storage.get_client(client_id, self.lawyer_id)
            
            if not client:
                return {
                    "success": False,
                    "message": "Ø§Ù„Ù…ÙˆÙƒÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ÙŠÙ†ØªÙ…ÙŠ Ù„Ùƒ"
                }
            
            # Generate new Case ID
            case_id = str(uuid.uuid4())
            
            case_data = {
                "case_id": case_id,
                "client_id": client_id,
                "case_number": case_number,
                "court_name": court_name,
                "case_type": case_type,
                "subject": subject,
                "client_capacity": client_capacity,
                "case_year": case_year,
                "case_date": case_date,
                "summary": summary,
                "court_circuit": court_circuit,
                "status": status
            }
            
            case = self.storage.save_case(case_data)
            
            return {
                "success": True,
                "case": case,
                "message": f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø¶ÙŠØ© Ø±Ù‚Ù… {case_number} Ù„Ù„Ù…ÙˆÙƒÙ„ {client['full_name']} Ø¨Ù†Ø¬Ø§Ø­ âœ…"
            }
        except Exception as e:
            logger.error(f"Failed to create case: {e}")
            return {
                "success": False,
                "error": str(e),
                "message": f"ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø¶ÙŠØ©: {str(e)}"
            }
    
    def search_cases(self, query: str) -> Dict[str, Any]:
        """Search cases (filtered by lawyer's clients) with Text Normalization"""
        try:
            from agents.utils.text_normalizer import TextNormalizer

            # Normalize query
            query_norm = TextNormalizer.normalize_arabic_text(query).lower()

            # Get all lawyer's clients first
            from agents.storage.client_storage import client_storage
            clients = client_storage.get_clients_by_lawyer(self.lawyer_id)
            client_ids = [c["id"] for c in clients]
            
            # Search cases for these clients
            all_cases = []
            for client_id in client_ids:
                cases = self.storage.get_cases_by_client(client_id)
                all_cases.extend(cases)
            
            # Filter by normalized query
            filtered_cases = []
            for case in all_cases:
                # Normalize case fields for comparison
                case_num = str(case.get("case_number", "")).lower()
                court = TextNormalizer.normalize_arabic_text(str(case.get("court_name", "")))
                subj = TextNormalizer.normalize_arabic_text(str(case.get("subject", "")))
                
                if (query_norm in case_num or 
                    query_norm in court or 
                    query_norm in subj):
                    filtered_cases.append(case)
            
            return {
                "success": True,
                "count": len(filtered_cases),
                "cases": filtered_cases,
                "message": f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(filtered_cases)} Ù‚Ø¶ÙŠØ©"
            }
        except Exception as e:
            logger.error(f"Failed to search cases: {e}")
            return {
                "success": False,
                "error": str(e),
                "cases": []
            }
    
    def get_case_details(self, case_id: str) -> Dict[str, Any]:
        """Get case with hearings (verify client belongs to lawyer)"""
        try:
            case = self.storage.get_case(case_id)
            
            if not case:
                return {
                    "success": False,
                    "message": "Ø§Ù„Ù‚Ø¶ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"
                }
            
            # Verify client belongs to this lawyer
            from agents.storage.client_storage import client_storage
            client = client_storage.get_client(case["client_id"], self.lawyer_id)
            
            if not client:
                return {
                    "success": False,
                    "message": "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø¶ÙŠØ©"
                }
            
            # Get hearings
            from agents.storage.hearing_storage import hearing_storage
            hearings = hearing_storage.get_case_hearings(case_id)
            
            case["hearings"] = hearings
            case["client"] = client
            
            return {
                "success": True,
                "case": case,
                "message": f"Ø§Ù„Ù‚Ø¶ÙŠØ© Ø±Ù‚Ù… {case['case_number']}"
            }
        except Exception as e:
            logger.error(f"Failed to get case details: {e}")
            return {
                "success": False,
                "error": str(e)
            }
    
    def list_client_cases(self, client_id: str) -> Dict[str, Any]:
        """List all cases for a client"""
        try:
            # Verify client
            from agents.storage.client_storage import client_storage
            client = client_storage.get_client(client_id, self.lawyer_id)
            
            if not client:
                return {
                    "success": False,
                    "message": "Ø§Ù„Ù…ÙˆÙƒÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
                }
            
            cases = self.storage.get_cases_by_client(client_id)
            
            return {
                "success": True,
                "count": len(cases),
                "cases": cases,
                "message": f"Ø§Ù„Ù…ÙˆÙƒÙ„ {client['full_name']} Ù„Ø¯ÙŠÙ‡ {len(cases)} Ù‚Ø¶ÙŠØ©"
            }
        except Exception as e:
            logger.error(f"Failed to list client cases: {e}")
            return {
                "success": False,
                "error": str(e),
                "cases": []
            }
    
    def list_active_cases(self) -> Dict[str, Any]:
        """List all active cases for lawyer"""
        try:
            from agents.storage.client_storage import client_storage
            clients = client_storage.get_clients_by_lawyer(self.lawyer_id)
            client_ids = [c["id"] for c in clients]
            
            all_cases = []
            for client_id in client_ids:
                cases = self.storage.get_cases_by_client(client_id)
                all_cases.extend(cases)
            
            # Filter active
            active_cases = [c for c in all_cases if c.get("status") == "active"]
            
            return {
                "success": True,
                "count": len(active_cases),
                "cases": active_cases,
                "message": f"Ù„Ø¯ÙŠÙƒ {len(active_cases)} Ù‚Ø¶ÙŠØ© Ù†Ø´Ø·Ø©"
            }
        except Exception as e:
            logger.error(f"Failed to list active cases: {e}")
            return {
                "success": False,
                "error": str(e),
                "cases": []
            }
    
    def update_case(self, case_id: str, updates: Dict[str, Any]) -> Dict[str, Any]:
        """Update case"""
        try:
            # Verify access
            case = self.storage.get_case(case_id)
            if not case:
                return {"success": False, "message": "Ø§Ù„Ù‚Ø¶ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"}
            
            from agents.storage.client_storage import client_storage
            client = client_storage.get_client(case["client_id"], self.lawyer_id)
            if not client:
                return {"success": False, "message": "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ"}
            
            updated_case = self.storage.update_case(case_id, updates)
            
            return {
                "success": True,
                "case": updated_case,
                "message": "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø¶ÙŠØ©"
            }
        except Exception as e:
            logger.error(f"Failed to update case: {e}")
            return {
                "success": False,
                "error": str(e)
            }
    
    def close_case(
        self,
        case_id: str,
        verdict_number: Optional[str] = None,
        verdict_date: Optional[str] = None,
        summary: Optional[str] = None
    ) -> Dict[str, Any]:
        """Close case"""
        updates = {"status": "closed"}
        
        if verdict_number:
            updates["verdict_number"] = verdict_number
        if verdict_date:
            updates["verdict_date"] = verdict_date
        if summary:
            updates["summary"] = summary
        
        return self.update_case(case_id, updates)


__all__ = ["CaseTools"]
