"""
Client Management Tools for AI Agent
Ø£Ø¯ÙˆØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ† Ù„Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
"""

from typing import Dict, Any, List, Optional
import logging

from agents.storage.client_storage import client_storage

logger = logging.getLogger(__name__)


class ClientTools:
    """Tools for managing clients with lawyer_id security filter"""
    
    def __init__(self, lawyer_id: str):
        """
        Initialize client tools
        
        Args:
            lawyer_id: Lawyer's user ID (from JWT token)
        """
        self.lawyer_id = lawyer_id
        self.storage = client_storage
        logger.info(f"âœ… ClientTools initialized for lawyer {lawyer_id}")
    
    def get_tools_list(self) -> List[Dict[str, Any]]:
        """
        Get list of available tools for the agent
        
        Returns:
            List of tool definitions
        """
        return [
            {
                "name": "create_client",
                "description": """
                Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆÙƒÙ„ Ø¬Ø¯ÙŠØ¯.
                Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ·Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙƒÙ„ Ø¬Ø¯ÙŠØ¯.
                
                Args:
                    full_name: Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…ÙˆÙƒÙ„ (Ø¥Ù„Ø²Ø§Ù…ÙŠ)
                    phone: Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    national_id: Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    email: Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    address: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    notes: Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ù…ÙˆÙƒÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    has_power_of_attorney: Ù‡Ù„ Ù„Ø¯ÙŠÙ‡ ÙˆÙƒØ§Ù„Ø©ØŸ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: False)
                    power_of_attorney_number: Ø±Ù‚Ù… Ø§Ù„ÙˆÙƒØ§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                
                Returns:
                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙƒÙ„ Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡
                """,
                "function": self.create_client
            },
            {
                "name": "search_clients",
                "description": """
                Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙƒÙ„ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ.
                Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ†.
                
                Args:
                    query: Ù†Øµ Ø§Ù„Ø¨Ø­Ø« (Ø§Ø³Ù…ØŒ Ø±Ù‚Ù… Ù‡Ø§ØªÙØŒ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©)
                
                Returns:
                    Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†
                """,
                "function": self.search_clients
            },
            {
                "name": "get_client_details",
                "description": """
                Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ù…ÙˆÙƒÙ„ Ù…Ø¹ÙŠÙ† Ù…Ø¹ Ù‚Ø¶Ø§ÙŠØ§Ù‡.
                
                Args:
                    client_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆÙƒÙ„ (UUID)
                
                Returns:
                    ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙƒÙ„ Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø¶Ø§ÙŠØ§Ù‡
                """,
                "function": self.get_client_details
            },
            {
                "name": "list_all_clients",
                "description": """
                Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ† Ù„Ù„Ù…Ø­Ø§Ù…ÙŠ.
                Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ³Ø£Ù„ Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø¹Ù† Ù…ÙˆÙƒÙ„ÙŠÙ‡.
                
                Returns:
                    Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ†
                """,
                "function": self.list_all_clients
            },
            {
                "name": "update_client",
                "description": """
                ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙƒÙ„.
                
                Args:
                    client_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆÙƒÙ„
                    updates: Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù„ØªØ­Ø¯ÙŠØ« (phone, email, address, notes, etc.)
                
                Returns:
                    Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                """,
                "function": self.update_client
            },
            {
                "name": "delete_client",
                "description": """
                Ø­Ø°Ù Ù…ÙˆÙƒÙ„.
                ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.
                
                Args:
                    client_id: Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆÙƒÙ„
                
                Returns:
                    Ù†Ø¬Ø§Ø­ Ø£Ùˆ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù
                """,
                "function": self.delete_client
            }
        ]
    
    def create_client(
        self,
        full_name: str,
        phone: Optional[str] = None,
        national_id: Optional[str] = None,
        email: Optional[str] = None,
        address: Optional[str] = None,
        notes: Optional[str] = None,
        has_power_of_attorney: bool = False,
        power_of_attorney_number: Optional[str] = None
    ) -> Dict[str, Any]:
        """Create new client"""
        try:
            client = self.storage.create_client(
                lawyer_id=self.lawyer_id,  # âš ï¸ Always filtered
                full_name=full_name,
                phone=phone,
                national_id=national_id,
                email=email,
                address=address,
                notes=notes,
                has_power_of_attorney=has_power_of_attorney,
                power_of_attorney_number=power_of_attorney_number
            )
            
            return {
                "success": True,
                "message": f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙƒÙ„ {full_name} Ø¨Ù†Ø¬Ø§Ø­",
                "client": client
            }
        except Exception as e:
            logger.error(f"Failed to create client: {e}")
            return {
                "success": False,
                "error": str(e),
                "message": f"ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙƒÙ„: {str(e)}"
            }
    
    def search_clients(self, query: str) -> Dict[str, Any]:
        """
        ğŸ” Smart search with fuzzy matching and suggestions
        """
        try:
            clients = self.storage.search_clients(
                lawyer_id=self.lawyer_id,
                query=query
            )
            
            # Build smart response
            if clients:
                # Check if these are fuzzy matches
                from agents.utils.arabic_utils import normalize_arabic
                normalized_query = normalize_arabic(query)
                
                # Check if any exact matches
                exact_matches = [
                    c for c in clients 
                    if normalized_query in normalize_arabic(c.get('full_name', ''))
                ]
                
                if exact_matches:
                    return {
                        "success": True,
                        "count": len(exact_matches),
                        "clients": exact_matches,
                        "message": f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(exact_matches)} Ù…ÙˆÙƒÙ„"
                    }
                else:
                    # Fuzzy matches - suggest "did you mean?"
                    suggestions = [c.get('full_name') for c in clients[:3]]
                    return {
                        "success": True,
                        "count": len(clients),
                        "clients": clients,
                        "fuzzy_match": True,
                        "suggestions": suggestions,
                        "message": f"Ù„Ù… Ø£Ø¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØ§Ù…Ø©. Ù‡Ù„ ØªÙ‚ØµØ¯ Ø£Ø­Ø¯ Ù‡Ø¤Ù„Ø§Ø¡ØŸ"
                    }
            else:
                return {
                    "success": True,
                    "count": 0,
                    "clients": [],
                    "message": f"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆÙƒÙ„ÙŠÙ† ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† '{query}'"
                }
        
        except Exception as e:
            logger.error(f"Failed to search clients: {e}")
            return {
                "success": False,
                "error": str(e),
                "clients": []
            }
    
    def get_client_details(self, client_id: str) -> Dict[str, Any]:
        """Get client with cases"""
        try:
            client = self.storage.get_client_with_cases(
                client_id=client_id,
                lawyer_id=self.lawyer_id
            )
            
            if not client:
                return {
                    "success": False,
                    "message": "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙƒÙ„"
                }
            
            cases_count = len(client.get("cases", []))
            return {
                "success": True,
                "client": client,
                "message": f"Ø§Ù„Ù…ÙˆÙƒÙ„: {client['full_name']}, Ù„Ø¯ÙŠÙ‡ {cases_count} Ù‚Ø¶ÙŠØ©"
            }
        except Exception as e:
            logger.error(f"Failed to get client details: {e}")
            return {
                "success": False,
                "error": str(e)
            }
    
    def list_all_clients(self) -> Dict[str, Any]:
        """List all lawyer's clients"""
        try:
            clients = self.storage.get_clients_by_lawyer(
                lawyer_id=self.lawyer_id,
                limit=100
            )
            
            return {
                "success": True,
                "count": len(clients),
                "clients": clients,
                "message": f"Ù„Ø¯ÙŠÙƒ {len(clients)} Ù…ÙˆÙƒÙ„"
            }
        except Exception as e:
            logger.error(f"Failed to list clients: {e}")
            return {
                "success": False,
                "error": str(e),
                "clients": []
            }
    
    def update_client(self, client_id: str, updates: Dict[str, Any]) -> Dict[str, Any]:
        """Update client"""
        try:
            client = self.storage.update_client(
                client_id=client_id,
                lawyer_id=self.lawyer_id,
                updates=updates
            )
            
            if not client:
                return {
                    "success": False,
                    "message": "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙƒÙ„ Ø£Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"
                }
            
            return {
                "success": True,
                "client": client,
                "message": "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙƒÙ„ Ø¨Ù†Ø¬Ø§Ø­"
            }
        except Exception as e:
            logger.error(f"Failed to update client: {e}")
            return {
                "success": False,
                "error": str(e)
            }
    
    def delete_client(self, client_id: str) -> Dict[str, Any]:
        """Delete client"""
        try:
            success = self.storage.delete_client(
                client_id=client_id,
                lawyer_id=self.lawyer_id
            )
            
            if success:
                return {
                    "success": True,
                    "message": "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙƒÙ„ Ø¨Ù†Ø¬Ø§Ø­"
                }
            else:
                return {
                    "success": False,
                    "message": "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙƒÙ„"
                }
        except Exception as e:
            logger.error(f"Failed to delete client: {e}")
            return {
                "success": False,
                "error": str(e)
            }


__all__ = ["ClientTools"]
